#!/usr/bin/env bash
# NGINX SSL Termination + Load Balancer Script for www.ekirabo.tech
# Passes HTTP health check on /health
set -e

# ---------------------------
# Variables
# ---------------------------
DOMAIN="www.ekirabo.tech"
SSL_DIR="/etc/ssl/private"
SSL_CERT="${SSL_DIR}/ekirabo.tech.crt"
SSL_KEY="${SSL_DIR}/ekirabo.tech.key"
BACKENDS=("3.89.92.200:80" "34.238.80.97:80")
NGINX_CONF="/etc/nginx/sites-available/1-nginx_ssl_termination"

# ---------------------------
# Install NGINX if missing
# ---------------------------
if ! command -v nginx >/dev/null 2>&1; then
    echo "Installing NGINX..."
    sudo apt update
    sudo apt install -y nginx
fi

# ---------------------------
# Create SSL directory
# ---------------------------
sudo mkdir -p "$SSL_DIR"
sudo chmod 700 "$SSL_DIR"

# ---------------------------
# Create a self-signed certificate if it doesn't exist
# ---------------------------
if [ ! -f "$SSL_CERT" ] || [ ! -f "$SSL_KEY" ]; then
    echo "Creating self-signed SSL certificate..."
    sudo openssl req -x509 -nodes -days 365 \
        -newkey rsa:2048 \
        -keyout "$SSL_KEY" \
        -out "$SSL_CERT" \
        -subj "/C=RW/ST=Kigali/L=Kigali/O=Holberton/CN=$DOMAIN"
    
    sudo chmod 600 "$SSL_KEY"
    sudo chmod 644 "$SSL_CERT"
fi

# ---------------------------
# Generate NGINX configuration
# ---------------------------
echo "Writing NGINX config to $NGINX_CONF..."

sudo tee "$NGINX_CONF" > /dev/null <<EOF
# Backend load balancing with health checks
upstream backend_servers {
    least_conn;  # Use least connections algorithm
EOF

for server in "${BACKENDS[@]}"; do
    echo "    server $server max_fails=3 fail_timeout=30s;" | sudo tee -a "$NGINX_CONF" > /dev/null
done

cat <<'EOF' | sudo tee -a "$NGINX_CONF" > /dev/null
}

# HTTP server - Health check + redirect
server {
    listen 80;
    listen [::]:80;
    server_name ${DOMAIN};

    # Health check endpoint (returns 200 OK)
    location /health {
        access_log off;
        return 200 "OK\n";
        add_header Content-Type text/plain;
    }

    # Redirect all other traffic to HTTPS
    location / {
        return 301 https://$host$request_uri;
    }
}

# HTTPS server - SSL Termination + Proxy
server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name ${DOMAIN};

    # SSL Configuration
    ssl_certificate     ${SSL_CERT};
    ssl_certificate_key ${SSL_KEY};
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_prefer_server_ciphers on;
    ssl_ciphers 'ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384';
    
    # Security headers
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;

    # Health check on HTTPS as well
    location /health {
        access_log off;
        return 200 "OK\n";
        add_header Content-Type text/plain;
    }

    # Proxy all other requests to backend
    location / {
        proxy_pass http://backend_servers;
        
        # Proxy headers
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Port $server_port;
        
        # Timeouts
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
        
        # Buffer settings
        proxy_buffering on;
        proxy_buffer_size 4k;
        proxy_buffers 8 4k;
        proxy_busy_buffers_size 8k;
    }

    # Logging
    access_log /var/log/nginx/${DOMAIN}-access.log;
    error_log /var/log/nginx/${DOMAIN}-error.log;
}
EOF

# Substitute variables in the config
sudo sed -i "s|\${DOMAIN}|$DOMAIN|g" "$NGINX_CONF"
sudo sed -i "s|\${SSL_CERT}|$SSL_CERT|g" "$NGINX_CONF"
sudo sed -i "s|\${SSL_KEY}|$SSL_KEY|g" "$NGINX_CONF"

# ---------------------------
# Remove default site if exists
# ---------------------------
if [ -L /etc/nginx/sites-enabled/default ]; then
    sudo rm /etc/nginx/sites-enabled/default
fi

# ---------------------------
# Enable configuration
# ---------------------------
sudo ln -sf "$NGINX_CONF" /etc/nginx/sites-enabled/

# ---------------------------
# Test and reload NGINX
# ---------------------------
echo "Testing NGINX configuration..."
sudo nginx -t

echo "Restarting NGINX..."
sudo systemctl restart nginx
sudo systemctl enable nginx

# ---------------------------
# Display status
# ---------------------------
echo ""
echo "=========================================="
echo "NGINX SSL Load Balancer Setup Complete!"
echo "=========================================="
echo "Domain: $DOMAIN"
echo "HTTP Port: 80 (redirects to HTTPS)"
echo "HTTPS Port: 443 (SSL Termination)"
echo "Backend Servers:"
for server in "${BACKENDS[@]}"; do
    echo "  - $server"
done
echo ""
echo "Health Check: http://$DOMAIN/health (returns 200 OK)"
echo "Health Check: https://$DOMAIN/health (returns 200 OK)"
echo ""
echo "Test commands:"
echo "  curl -I http://$DOMAIN/health"
echo "  curl -Ik https://$DOMAIN/health"
echo "  curl -I http://$DOMAIN  # Should redirect to HTTPS"
echo "=========================================="
